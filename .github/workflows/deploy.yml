name: Deploy Theme to Pressable

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Select deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - live

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Show recent changes (this deploy)
        run: |
          echo "## Latest commit"
          git log -1 --oneline
          echo ""
          echo "## Files changed in latest commit"
          git diff --name-only HEAD~1 HEAD || git diff --name-only HEAD
          echo ""
          echo "Rsync will sync only changed files to the server (incremental)."

      - name: Set environment variables
        id: set-env
        run: |
          if [ "${{ github.event.inputs.environment }}" == "live" ]; then
            echo "SSH_USER=${{ secrets.PRESSABLE_LIVE_SSH_USER }}" >> $GITHUB_OUTPUT
            echo "SSH_PASS=${{ secrets.PRESSABLE_LIVE_SSH_PASS }}" >> $GITHUB_OUTPUT
            echo "THEME_PATH=${{ secrets.PRESSABLE_LIVE_THEME_PATH }}" >> $GITHUB_OUTPUT
            echo "ðŸš€ Deploying to LIVE server"
          else
            echo "SSH_USER=${{ secrets.PRESSABLE_SSH_USER }}" >> $GITHUB_OUTPUT
            echo "SSH_PASS=${{ secrets.PRESSABLE_SSH_PASS }}" >> $GITHUB_OUTPUT
            echo "THEME_PATH=${{ secrets.PRESSABLE_THEME_PATH }}" >> $GITHUB_OUTPUT
            echo "ðŸ§ª Deploying to STAGING server"
          fi

      - name: Install sshpass
        run: sudo apt-get install -y sshpass

      - name: Deploy via Rsync with Password
        env:
          SSHPASS: ${{ steps.set-env.outputs.SSH_PASS }}
        run: |
          echo "Deploying to: ${{ github.event.inputs.environment }}"
          sshpass -e rsync -avz --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='.gitignore' \
            --exclude='node_modules' \
            --exclude='.DS_Store' \
            -e "ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null" \
            ./ \
            ${{ steps.set-env.outputs.SSH_USER }}@ssh.atomicsites.net:${{ steps.set-env.outputs.THEME_PATH }}/

      - name: Deployment Complete
        run: |
          echo "âœ… Successfully deployed to ${{ github.event.inputs.environment }}"
